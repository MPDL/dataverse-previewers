<html>

<head>
    <meta charset="utf-8">
    <title class="zipPreviewText">Zip Preview</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="lib/zip.min.js"></script>
    <script src="lib/jquery.i18n.js"></script>
    <script src="lib/jquery.i18n.messagestore.js"></script>
    <script src="lib/jquery.i18n.language.js"></script>



    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap-theme.min.css" integrity="sha384-6pzBo3FDv/PJ8r2KRkGHifhEocL+1X2rVCTTkUfGk7/0pbek5mMa1upzvWbrUbOZ" crossorigin="anonymous">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>

    <link type="text/css" rel="stylesheet" href="css/preview.css" />
    <script>




        readZip();

        async function readZip() {

    
        // create a BlobReader to read with a ZipReader the zip from a Blob object
        /*
        const reader = new zip.ZipReader(new zip.HttpReader(
            'https://dev-edmond-objstor-hdd.s3.gwdg.de/10.17617/3.FFFODN/18021f013f2-7b8aa3cff752?response-content-disposition=attachment%3B%20filename%2A%3DUTF-8%27%27BalsacGallery.zip&response-content-type=application%2Fzip&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Date=20220511T093351Z&X-Amz-SignedHeaders=host&X-Amz-Expires=86399&X-Amz-Credential=W7RIGMB4SLQMPMLDY4FF%2F20220511%2Fdataverse%2Fs3%2Faws4_request&X-Amz-Signature=097f93182156ef82f96bd4dd6a41098b1656cb22f08e0f6e28ea840f405069dd',
            {forceRangeRequests: false}));
            */

        //const url = 'https://s3.gwdg.de/prod-edmond-objstor-hdd/markus/test.zip';    
        const url = 'http://localhost:8080/api/access/datafile/15426';     
        //const url ='https://prod-edmond-objstor-hdd.s3.gwdg.de/10.15771/3./DUMG88/180b789bd97-bdf8a52a9cdd?response-content-disposition=attachment%3B+filename*%3DUTF-8%27%27BalsacGallery.zip&response-content-type=application%2Fzip&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Date=20220512T091920Z&X-Amz-SignedHeaders=host&X-Amz-Expires=86400&X-Amz-Credential=EXO9K6TK51E5WUPNNVJ3%2F20220512%2Fdataverse%2Fs3%2Faws4_request&X-Amz-Signature=60e75aff6ccfb175e452f55d58aee06daa23118fa398b71d622ec305991aae26';    
        const reader = new zip.ZipReader(new zip.HttpRangeReader(url));

        // get all entries from the zip
        
        const entries = await reader.getEntries();
        if (entries.length) {

            const entryMap = {};
            entryMap['root'] = document.createElement('ul');
            entryMap['root'].setAttribute('id', 'tree');
            document.getElementById('zipPreview').appendChild(entryMap['root']);
            //console.log(entries);

            entries.forEach(entry => {

                let filename = entry.filename;
                //remove slash at end of string if available
                if(filename.endsWith('/')) {
                    filename = filename.slice(0, filename.length-1);
                }

                //split into parts before and after last slash
                const lastIndex = filename.lastIndexOf('/');
                let before = 'root';
                if(lastIndex != -1) {
                    before = filename.slice(0, lastIndex + 1);
                }
                const after = filename.slice(lastIndex + 1);
                //console.log(entry.filename + "   Before: " + before + "   After: " + after);
                //console.log(entry);
                const humanReadableSize = " (" + fileSizeSI(entry.uncompressedSize) + ")";
                const parentListNode = entryMap[before];
                const listNode = document.createElement("li");
                const textnode = document.createTextNode(after + (!entry.directory ? humanReadableSize : ""));
                listNode.appendChild(textnode);
                parentListNode.appendChild(listNode);

                if(entry.directory) {
                    const ulNode = document.createElement('ul');
                    parentListNode.appendChild(ulNode);
                    entryMap[entry.filename] = ulNode;
                }
                



            });

            




       /*
            // get first entry content as text by using a TextWriter
        const text = await entries[0].getData(
            // writer
            new zip.TextWriter(),
            // options
            { 
            onprogress: (index, max) => {
                // onprogress callback
            }
            }
        );
        // text contains the entry data as a String
        console.log(text);

        }
        */

        // close the ZipReader
            await reader.close();

        }
    }

    function fileSizeSI(a,b,c,d,e){
        return (b=Math,c=b.log,d=1000,e=c(a)/c(d)|0,a/b.pow(d,e)).toFixed(2)
        +' '+(e?'kMGTPEZY'[--e]+'B':'Bytes')
    }

    

    </script>

</head>

<body class="container">
    <main>
        <img id='logo' alt='Site Logo'>
        <h1 class="page-title zipPreviewText">Zip Preview</h1>
        <div class='preview-container'>
            <div class='preview-header'></div>
            <div id="zipPreview" class='preview'>
                <img src=""
            </div>
        </div>
    </main>
</body>

</html>
