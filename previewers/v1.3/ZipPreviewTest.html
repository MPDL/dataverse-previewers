<html>

<head>
    <meta charset="utf-8">
    <title class="zipPreviewText">Zip Preview</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="lib/zip/zip.min.js"></script>
    <script src="lib/jquery.i18n.js"></script>
    <script src="lib/jquery.i18n.messagestore.js"></script>
    <script src="lib/jquery.i18n.language.js"></script>



    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap-theme.min.css" integrity="sha384-6pzBo3FDv/PJ8r2KRkGHifhEocL+1X2rVCTTkUfGk7/0pbek5mMa1upzvWbrUbOZ" crossorigin="anonymous">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>

    <link type="text/css" rel="stylesheet" href="css/preview.css" />
    <script>


        let entries;

        readZip();

        async function readZip() {

    
        // create a BlobReader to read with a ZipReader the zip from a Blob object
        /*
        const reader = new zip.ZipReader(new zip.HttpReader(
            'https://dev-edmond-objstor-hdd.s3.gwdg.de/10.17617/3.FFFODN/18021f013f2-7b8aa3cff752?response-content-disposition=attachment%3B%20filename%2A%3DUTF-8%27%27BalsacGallery.zip&response-content-type=application%2Fzip&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Date=20220511T093351Z&X-Amz-SignedHeaders=host&X-Amz-Expires=86399&X-Amz-Credential=W7RIGMB4SLQMPMLDY4FF%2F20220511%2Fdataverse%2Fs3%2Faws4_request&X-Amz-Signature=097f93182156ef82f96bd4dd6a41098b1656cb22f08e0f6e28ea840f405069dd',
            {forceRangeRequests: false}));
            */

        //const url = 'https://s3.gwdg.de/prod-edmond-objstor-hdd/markus/test.zip';    
        const url = 'http://localhost:8080/api/access/datafile/15426';     
        //const url ='https://prod-edmond-objstor-hdd.s3.gwdg.de/10.15771/3./DUMG88/180b789bd97-bdf8a52a9cdd?response-content-disposition=attachment%3B+filename*%3DUTF-8%27%27BalsacGallery.zip&response-content-type=application%2Fzip&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Date=20220512T091920Z&X-Amz-SignedHeaders=host&X-Amz-Expires=86400&X-Amz-Credential=EXO9K6TK51E5WUPNNVJ3%2F20220512%2Fdataverse%2Fs3%2Faws4_request&X-Amz-Signature=60e75aff6ccfb175e452f55d58aee06daa23118fa398b71d622ec305991aae26';    
        const reader = new zip.ZipReader(new zip.HttpRangeReader(url));

        // get all entries from the zip
        
        entries = await reader.getEntries();
        if (entries.length) {
            console.log(entries);

            const entryMap = {};
            entryMap['root'] = document.createElement('ul');
            entryMap['root'].setAttribute('id', 'tree');
            document.getElementById('zip-preview').appendChild(entryMap['root']);
            //console.log(entries);

            entries.forEach(function(entry, index) {

                let filename = entry.filename;
                //remove slash at end of string if available
                if (filename.endsWith('/')) {
                    filename = filename.slice(0, filename.length - 1);
                }

                //split into parts before and after last slash
                const lastIndex = filename.lastIndexOf('/');
                let before = 'root';
                if (lastIndex != -1) {
                    before = filename.slice(0, lastIndex + 1);
                }
                const after = filename.slice(lastIndex + 1);
                //console.log(entry.filename + "   Before: " + before + "   After: " + after);
                //console.log(entry);
                const humanReadableSize = " (" + fileSizeSI(entry.uncompressedSize) + ")";
                const parentListNode = entryMap[before];

                //options for jsTree
                const jsTreeOptions = {};
                jsTreeOptions['opened'] = true;
                jsTreeOptions['disabled'] = true;
                if (entry.directory) {
                    jsTreeOptions['icon'] = 'glyphicon glyphicon-folder-open';
                }
                else {
                    jsTreeOptions['icon'] = 'glyphicon glyphicon-file';
                }


                //create li element and set tree options and text
                const listNode = document.createElement("li");
                listNode.setAttribute('data-jstree', JSON.stringify(jsTreeOptions))
                const textnode = document.createTextNode(after + (!entry.directory ? humanReadableSize : ""));

                listNode.appendChild(textnode);

                //Add li element to parent ul element
                parentListNode.appendChild(listNode);

                //Add new ul element, if entry is a directory
                if (entry.directory) {
                    const ulNode = document.createElement('ul');
                    listNode.appendChild(ulNode);
                    entryMap[entry.filename] = ulNode;
                }
                else{
                    const downloadLink = $('<a href="#" data-entry-index="' + index + '">Download<a>');
                    downloadLink.click(downloadFile);
                    $(listNode).append(downloadLink);
                    

                }




            });
        }


            




       /*
            // get first entry content as text by using a TextWriter
        const text = await entries[0].getData(
            // writer
            new zip.TextWriter(),
            // options
            { 
            onprogress: (index, max) => {
                // onprogress callback
            }
            }
        );
        // text contains the entry data as a String
        console.log(text);

        }
        */

        // close the ZipReader
            await reader.close();

        
    }

    async function downloadFile(event) {
        console.log('Download clicked');
			const target = event.target;
			let href = target.getAttribute("href");
			if (target.dataset.entryIndex !== undefined && !target.download) {
                console.log('inside');
				target.removeAttribute("href");
				event.preventDefault();
				try {
					await download(entries[Number(target.dataset.entryIndex)], target.parentElement, target);
					href = target.getAttribute("href");
				} catch (error) {
					alert(error);
				}
				target.setAttribute("href", href);
			}
	}

    async function download(entry, li, a) {
			if (!li.classList.contains("busy")) {
				const unzipProgress = document.createElement("progress");
				li.appendChild(unzipProgress);
				const controller = new AbortController();
				const signal = controller.signal;
				const abortButton = document.createElement("button");
				abortButton.onclick = () => controller.abort();
				abortButton.textContent = "âœ–";
				abortButton.title = "Abort";
				li.appendChild(abortButton);
				li.classList.add("busy");
				try {
                    const blobURL = URL.createObjectURL(await entry.getData(new zip.BlobWriter(), {
						//password: passwordInput.value,
						onprogress: (index, max) => {
							unzipProgress.value = index;
							unzipProgress.max = max;
						},
						signal}))
                        /*
					const blobURL = await model.getURL(entry, {
						password: passwordInput.value,
						onprogress: (index, max) => {
							unzipProgress.value = index;
							unzipProgress.max = max;
						},
						signal
					});
                    */
					a.href = blobURL;
					a.download = entry.filename;
					const clickEvent = new MouseEvent("click");
					a.dispatchEvent(clickEvent);
				} catch (error) {
					if (error.message != zip.ERR_ABORT) {
						throw error;
					}
				} finally {
					li.classList.remove("busy");
					unzipProgress.remove();
					abortButton.remove();
				}
			}
		}


    function fileSizeSI(a,b,c,d,e){
        return (b=Math,c=b.log,d=1000,e=c(a)/c(d)|0,a/b.pow(d,e)).toFixed(2)
        +' '+(e?'kMGTPEZY'[--e]+'B':'Bytes')
    }

    

    </script>

</head>

<body class="container">
    <main>
        <img id='logo' alt='Site Logo'>
        <h1 class="page-title zipPreviewText">Zip Preview</h1>
        <div class='preview-container'>
            <div class='preview-header'></div>
            <div id="zip-preview" class='preview'>

            </div>
        </div>
    </main>
</body>

</html>
